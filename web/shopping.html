<html>
<head>
<!-- Bootstrap core CSS -->
<link href="./dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Custom styles for this template -->
<link href="css/navbar.css" rel="stylesheet">

    <script type="text/javascript" src="easyui/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="easyui/demo/demo.css">
    <script type="text/javascript" src="easyui/jquery.easyui.min.js" ></script>


    <title>User Interface</title>


    <script>

    //Shopping Cart
    var cartData = {"total":0,"rows":[]};
    var totalCost = 0;
	var testData = '{"total":50,"rows":[{"actionErrors":[],"actionMessages":[],"authorIds":[17],"authors":"48LjCwVMw;","bookCatagory":"a","bookName":"UOaqxt0NWEUbj","bookPrice":1.0,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"0DvU_heaXYWeF","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[5],"authors":"xDlVZ294Qjq;","bookCatagory":"b","bookName":"Ov60Vr7g4","bookPrice":717.78,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"1B9vorLL75uoP","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[4],"authors":"J20ixY07d2TI3o;","bookCatagory":"d","bookName":"iTe3afMfmKUy","bookPrice":511.89,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"1M5f3HU5a","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"b","bookName":"OmFSqynDLl","bookPrice":313.93,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"2e5SENTR","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"b","bookName":"cEQpMxahH","bookPrice":858.74,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"2lYhasT6","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"d","bookName":"r1OPjowv5","bookPrice":330.8,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"43glWUuNqLHy","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[10],"authors":"EUYEyZ6c;","bookCatagory":"e","bookName":"WSOiZHPrf","bookPrice":213.9,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"6oDbaiXU5","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"a","bookName":"tMjVhQab5BoDw","bookPrice":784.99,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"6SyEVb1N","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[13],"authors":"uwIPvQPioFT1Tx;","bookCatagory":"f","bookName":"YlKC3kvIkkxv3","bookPrice":286.22,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"BmRvBiARu","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"f","bookName":"w6YrPbIT5xVjVx","bookPrice":34.96,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"c9hvKwANDfijGF","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"g","bookName":"Lp_Sb6LP3Ud","bookPrice":930.47,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"cEyiqbr7wcyFT","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"b","bookName":"IteKgQn35QXpV","bookPrice":12.23,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"DoA1ChcH1aiQQj","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[26],"authors":"mxcuJqtVZ;","bookCatagory":"e","bookName":"B7HqXk4J8","bookPrice":587.62,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"EkGP1iGyAL1ho","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"g","bookName":"q89k0Ne0l","bookPrice":501.84,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"eZgXTGsFA8dXw","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[22],"authors":"s0lFScHV;","bookCatagory":"f","bookName":"aTgNA8UJ","bookPrice":83.53,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"fe8WYdwHtnW6_g","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"a","bookName":"nwWjyvMox","bookPrice":560.06,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"gDyQMtLqEP9P","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[8],"authors":"TUas6ttmKuhic;","bookCatagory":"a","bookName":"S7iDikmG7fH2A","bookPrice":45.64,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"h8Atei9ONIcus","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"d","bookName":"_EwNFnLBZYEt","bookPrice":405.72,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"hlWaSCmrS","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"e","bookName":"ZGlD1ee5SEN","bookPrice":664.14,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"hp9IbGQ8CYr","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[7],"authors":"eMfq605maX;","bookCatagory":"d","bookName":"AT9aEQufeNcB_o","bookPrice":226.02,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"hpwOYd2p4TciF","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"e","bookName":"wr_JTcZ0","bookPrice":706.76,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"I40TgIpG0NAdc","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[27],"authors":"10EpFFEncV;","bookCatagory":"g","bookName":"lPYo0q_etV","bookPrice":119.16,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"k0H1bHhJwmK","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[19],"authors":"xBGQhMmutVd;","bookCatagory":"e","bookName":"9hQTtpxNiw","bookPrice":144.62,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"kQ1vywVb","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[15],"authors":"lcLm94YAClnTJ_;","bookCatagory":"c","bookName":"_wgvOEFh67Oews","bookPrice":244.44,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"leUuHaop","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"a","bookName":"6ZaanMyEtn","bookPrice":371.46,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"M2KKwtmrk","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[9],"authors":"eJDjVfh_WAHA8o;","bookCatagory":"g","bookName":"VYGFebhK2p9","bookPrice":833.78,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"NmR7il8dWfE","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"f","bookName":"Kruf4URUVwg","bookPrice":912.3,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"NScG3YMw","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"c","bookName":"qLYuGrhlR","bookPrice":764.95,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"ocjevqgMOGQ5j","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[20],"authors":"YOo5qjW30d8CiO;","bookCatagory":"e","bookName":"aVfTcEX4Jn","bookPrice":433.1,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"OlNFE7KVlRs","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"c","bookName":"9SOykxIXpMKfp","bookPrice":167.73,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"OW4_85UsFr8","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[30],"authors":"ebtsmx1X5eSTn;","bookCatagory":"c","bookName":"mUt36s3MGuq_","bookPrice":632.02,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"oYOnITAGHRT28","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"e","bookName":"bylpLESKpFxE","bookPrice":391.74,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"pLdQ3pS8s","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[3],"authors":"yLmM2hdExu61;","bookCatagory":"f","bookName":"jWmrV1ymwDFv","bookPrice":805.53,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"qIR47Kjc7","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[1],"authors":"IFAhWo14wtU;","bookCatagory":"g","bookName":"EyISpHo9TgXS","bookPrice":548.75,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"QJQOGYiUcf991","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"d","bookName":"UDnjudmkwg7W9","bookPrice":732.22,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"r5p9vbJsCMN","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[28],"authors":"VMMZHmjcU;","bookCatagory":"b","bookName":"pWRH9QP2uAJ","bookPrice":613.93,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"rGUWCdpy","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"c","bookName":"Jxe4H6_n4BjDC","bookPrice":257.97,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"RLD5dD5LRKJI","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[11],"authors":"ahQ4Li1mr1;","bookCatagory":"c","bookName":"nnbf2mEocm41u","bookPrice":742.79,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"SdXPEjfbkCPQDU","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[14],"authors":"GjrWdnss7Znduw;","bookCatagory":"g","bookName":"vbE55jB4C","bookPrice":456.02,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"TBwxE5Jc8ETfLt","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[29],"authors":"egGJ9JIxGBXN;","bookCatagory":"d","bookName":"AWolBGJFaXs","bookPrice":57.5,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"tT5KrN4u_I","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[16],"authors":"uj_F5IRI;","bookCatagory":"b","bookName":"W7HaVb7uQ","bookPrice":187.32,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"TvkZ3Aq9BbP7","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[24],"authors":"8Gb90sqaW;","bookCatagory":"f","bookName":"mIPdJIeP","bookPrice":105.48,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"UrAUpVcP_EH3o9","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[2],"authors":"3QI5urxNbMpaD;","bookCatagory":"b","bookName":"Mvls72AYNQji_C","bookPrice":889.54,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"v7sydmloOd2","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[25],"authors":"c_H9R13cLwSfo;","bookCatagory":"g","bookName":"BeNuAeaZU1R5R","bookPrice":648.7,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"wSLNN3fE","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[],"authors":"","bookCatagory":"f","bookName":"FnvgPK9W","bookPrice":538.56,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"XebU7wH5kVPgJ1","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[18],"authors":"CQDCJlXhV;","bookCatagory":"a","bookName":"dBtAPpePUFlm57","bookPrice":876.0,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"XP3sA54XZekvX5","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[23],"authors":"LGbAZ7w8_Zx1d6;","bookCatagory":"c","bookName":"XeO52h_Ih","bookPrice":680.97,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"xYLJCtowLKGOqI","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[21],"authors":"w_NcRIW93CfPZ;","bookCatagory":"d","bookName":"E22WncqK","bookPrice":352.07,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"Yo8Gq9RFokDSa","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[12],"authors":"CdDhTMvnrN;","bookCatagory":"f","bookName":"9CcoU1lGPDQ","bookPrice":815.57,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"YYa6kfjycxVcH5","locale":"en_US","texts":null},{"actionErrors":[],"actionMessages":[],"authorIds":[6],"authors":"NRedJDCk;","bookCatagory":"a","bookName":"5KNaHGZHg","bookPrice":477.29,"errorMessages":[],"errors":{},"fieldErrors":{},"isbn":"_Hq7sgu3_N","locale":"en_US","texts":null}]}';
	
	
	
        $(document).ready(function(){

            $('#cartcontent').datagrid({
                singleSelect:true,
                url:'',
                columns:[[
                    {field:'bookname',title:'Name',width:100},
                    {field: 'quantity', title: 'Storage', width: 30,  sortable: true,
                        sorter:function(a,b){
                            return (a>b?1:-1);
                        }
                    },
                    {field: 'price', title: 'Price', width: 30,  sortable: true,
                        sorter:function(a,b){
                            return (a>b?1:-1);
                        }
                    },
                    {field:'opt',title:'Operation',width:0,align:'center',
                        formatter:function(value, row ,index){
                            cartData = $("#cartcontent").datagrid("getData");
                            totalCost = 0;
                            for(var i = 0 ; i < cartData.total ; i++)
                            {
                                totalCost += (cartData.rows[i].price) * (cartData.rows[i].quantity);
                            }
                            $('div.cart .total').html('Total: '+totalCost);
                            console.log(cartData);
                            return '<button class="removeCart" onclick="removeCartSelected(' + index + ')">Remove</button>';
                        }
                    }
                ]]
            });

            $('#bookView').datagrid({
                title:'Books overview',
                iconCls:'icon-save',
                width:700,
                height:350,
                nowrap: true,
				data: JSON.parse(testData),
                    autoRowHeight: true,
                    striped: true,
                    collapsible:true,
                    sortOrder: 'desc',
                    remoteSort: false,
                    idField:'i',
                    columns:[[
                        {field:'isbn',title:'isbn',width:30},
                        {field:'bookName',title:'Name',width:200},
                        {field:'bookCatagory',title:'Catagory',width:100,sortable:true,
                            sorter:function(a,b){
                                return (a>b?1:-1);
                            }
                        },
                        {field: 'bookPrice', title: 'Price', width: 100,  sortable: true,
                            sorter:function(a,b){
                                return (a>b?1:-1);
                            }
                        },
                        {field:'opt',title:'Operation',width:0,align:'center',
                            formatter:function(value, row, index){
                                console.log("add to cart index=", index);
                                return '<button class="addCart" onclick="getCartSelected(' + index + ')">Add to cart</button>';
                            }
                        }
                    ]],
                    pagination:true,
                    rownumbers:true
                });
			$("#bookView").datagrid("loadData", testData);
				
        });
        function success(data){
            console.log(data);
        }
        function getCartSelected(index){
            console.log("select+"+index);
            $("#bookView").datagrid("selectRow", index);
            var selected = $('#bookView').datagrid('getSelected');
            console.log("selected = " + selected);
            if (selected){
                addProduct(index, selected.isbn, selected.bookname, parseFloat(selected.price) );
            }
        }

        function removeCartSelected(index)
        {
            $("#cartcontent").datagrid("selectRow", index);
            var selected = $('#cartcontent').datagrid('getSelected');
            if(selected)
            {
                removeProduct(index, selected.isbn)
            }
        }

        function addProduct(index,isbn,name,price){
            console.log("adding");
            console.log($("#cartcontent").datagrid("getData"));
            cartData = $("#cartcontent").datagrid("getData");
            if(isNaN(cartData.total))
            {
                cartData = {"total":0,"rows":[]};
            }
            function add(){
                console.log("in add");
                for(var i=0; i<cartData.total; i++){
                    var row = cartData.rows[i];
                    if (row.isbn == isbn){
                        row.quantity += 1;
                        return;
                    }
                }
                console.log("create new");
                cartData.total += 1;
                cartData.rows.push({
                    index_id: index,
                    isbn: isbn,
                    bookname:name,
                    quantity:1,
                    price:price
                });
            }
            add();
            totalCost += price;
            $('#cartcontent').datagrid('loadData', cartData);
            console.log("loaded");
            $('div.cart .total').html('Total: '+totalCost);
            console.log("div update");
        }

        function removeProduct(index, isbn){
            console.log("removing");
            console.log("isbn=" + isbn);
            cartData =  $('#cartcontent').datagrid('getData');
            console.log(cartData);

            function remove(){
                console.log(cartData);
                for(var i = 0; i<cartData.total; i++){
                    var row = cartData.rows[i];
                    console.log("remove i=" + i);
                    console.log(row.isbn);
                    console.log(isbn);
                    if (row.isbn == isbn){
                        cartData.rows[i].quantity -= 1;
                        totalCost -= row.price;
                        if(row.quantity == 0)
                        {
                            cartData.total -= 1;
                            cartData.rows.splice(i,1);
                        }
                        return;
                    }
                }

            }
            remove();
            console.log("remove done");
            $('#cartcontent').datagrid('loadData', cartData);
            $('div.cart .total').html('Total: '+totalCost);
            console.log("div update");
        }

        function upload(){
            $.ajax({
                url: "addCart",
                type: "post",
                dataType: "json",
                data:{
                    rowData: JSON.stringify($('#cartcontent').datagrid('getData'))
                },
                success: function(data){
                    alert("upload success");
                },
                error: function(data){
                    alert("upload failed");
                    alert(data.msg);
                }
            });
        }

    </script>
</head>



<body >

<div class="container">
    <div class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">

                <a class="navbar-brand" href="#">Book view</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li class="active"><a href="./">Sign out</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div><!--/.container-fluid -->
    </div>
    <div class="row">
        <div class="col-lg-8">
            <p></p>
            <table id="bookView" singleSelect="true"></table>
        </div>
        <div class="col-lg-4">
            <div class="cart">
                <p>Shopping Cart</p>
                <table id="cartcontent" style="width:400px;height:auto;">
                    <thead>
                    <tr>
                        <th field="id" width=0></th>
                        <th field="index_id" width=0></th>
                        <th field="bookName" width=140>Book Name</th>
                        <th field="quantity" width=60 align="right">Quantity</th>
                        <th field="price" width=60 align="right">Price</th>
                        <th field="Operation" width=60 align="right">
                        </th>
                    </tr>
                    </thead>
                </table>
                <p class="total">Total: $0</p>
                <button onclick="upload()">Done</button>
            </div>
        </div>
    </div>
    </div>
</body>
</html>
